{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1 class="my-4">職員一括作成</h1>

    <!-- [修正点1] エラーメッセージの表示部分 -->
    <!-- formset全体のエラーを表示 -->
    {% if formset.non_form_errors %}
    <div class="alert alert-danger">
        <ul>
            {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- 各フォームのエラーを個別に表示 -->
    {% for form in formset %}
    {% if form.errors %}
    <div class="alert alert-danger">
        <ul>
            {% for error in form.errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% endfor %}

    <!-- フォーム全体 -->
    <form method="post">
        {% csrf_token %}
        <!-- [修正点2] 管理フォームを1箇所に統一 -->
        {{ formset.management_form }}

        <!-- フォームの入力フィールドを表示 -->
        <table class="table" id="employee-table">
            <thead>
                <tr>
                    <th>氏名</th>
                    <th>メールアドレス</th>
                    <th>部門</th>
                    <th>部署</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- [修正点3] 既存のフォームを1行ずつ表示 -->
                {% for form in formset %}
                <tr>
                    <td>{{ form.name }}</td>
                    <td>{{ form.email }}</td>
                    <td>{{ form.division }}</td>
                    <td>{{ form.team }}</td>
                    <td><button type="button" class="btn btn-danger remove-row">削除</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- フォーム送信ボタン -->
        <button type="submit" class="btn btn-primary">一括作成</button>
    </form>

    <!-- 戻るボタン -->
    <div class="mt-3">
        <a href="{% url 'employee:index' %}" class="btn btn-secondary">戻る</a>
    </div>
</div>

<!-- JavaScriptで行追加/削除やクリップボードペースト処理 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let rowCount = {{ formset.total_form_count }}; // [修正点4] 初期フォーム数をサーバー側から取得
        const tableBody = document.querySelector('#employee-table tbody'); // tbody要素を取得
        const totalFormsField = document.querySelector('[name="form-TOTAL_FORMS"]'); // TOTAL_FORMSフィールドを取得

        // [修正点5] 行追加機能の定義
        const addRow = () => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" name="form-${rowCount}-name" class="form-control" required></td>
                <td><input type="email" name="form-${rowCount}-email" class="form-control" required></td>
                <td><input type="text" name="form-${rowCount}-division" class="form-control"></td>
                <td><input type="text" name="form-${rowCount}-team" class="form-control"></td>
                <td><button type="button" class="btn btn-danger remove-row">削除</button></td>
            `;
            tableBody.appendChild(newRow); // 新しい行をtbodyに追加
            rowCount++; // 行数を更新
            totalFormsField.value = rowCount; // TOTAL_FORMSを更新
        };

        // [修正点6] 行削除機能の定義
        tableBody.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-row')) {
                const row = event.target.closest('tr'); // 削除対象の行を取得
                row.remove(); // 行を削除
                rowCount--; // 行数を減少
                totalFormsField.value = rowCount; // TOTAL_FORMSを更新
            }
        });

        // [修正点7] クリップボードペースト時の処理
        const handlePaste = (event) => {
            event.preventDefault(); // デフォルトのペースト動作を無効化
            const clipboardData = event.clipboardData.getData('Text'); // ペーストされたテキストを取得
            const rows = clipboardData.split('\n'); // 改行で分割して行データを生成

            rows.forEach((row, index) => {
                const columns = row.split('\t'); // 各行をタブで分割
                if (columns.length >= 2) {
                    addRow(); // 必要に応じて新しい行を追加
                    const inputs = tableBody.querySelectorAll(`tr:nth-last-child(1) input`);
                    inputs[0].value = columns[0]; // 氏名
                    inputs[1].value = columns[1]; // メールアドレス
                    if (columns[2]) inputs[2].value = columns[2]; // 部門
                    if (columns[3]) inputs[3].value = columns[3]; // 部署
                }
            });
        };

        document.querySelector('#employee-table').addEventListener('paste', handlePaste);
    });
</script>
{% endblock %}
