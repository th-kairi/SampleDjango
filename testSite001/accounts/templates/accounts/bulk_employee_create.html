{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1 class="my-4">職員一括作成</h1>

    <!-- エラーメッセージの表示部分 -->
    {% if formset.non_form_errors %}
    <div class="alert alert-danger">
        <ul>
            {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% for form in formset %}
    {% if form.errors %}
    <div class="alert alert-danger">
        <ul>
            {% for error in form.errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% endfor %}


    <!-- フォーム全体を囲む -->
    <form method="post">
        {% csrf_token %}
        {{ formset.management_form }}
        <!-- 入力フィールドのテーブル -->
        <table class="table" id="employee-table">
            <thead>
                <tr>
                    <th>氏名</th>
                    <th>メールアドレス</th>
                    <th>部門</th>
                    <th>部署</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- 最初の行を作成（空の入力欄を持つ行） -->
                {% for form in formset %}
                <tr>
                    <td><input type="text" name="name" class="form-control" id="name-1" required></td>
                    <td><input type="email" name="email" class="form-control" id="email-1" required></td>
                    <td><input type="text" name="division" class="form-control" id="division-1"></td>
                    <td><input type="text" name="team" class="form-control" id="team-1"></td>
                    <td><button type="button" class="btn btn-danger remove-row">削除</button></td>
                </tr>
                {% empty %}
                <!-- フォームセットが空の場合は、最低でも1行を表示 -->
                <tr>
                    <td>{{ formset.management_form }}</td> <!-- フォームセット管理用 -->
                    <td><input type="text" name="name" class="form-control" required></td>
                    <td><input type="email" name="email" class="form-control" required></td>
                    <td><input type="text" name="division" class="form-control"></td>
                    <td><input type="text" name="team" class="form-control"></td>
                    <td><button type="button" class="btn btn-danger remove-row">削除</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- フォーム送信ボタン -->
        <button type="submit" class="btn btn-primary">一括作成</button>
    </form>

    <!-- 戻るボタン -->
    <div class="mt-3">
        <a href="{% url 'employee:index' %}" class="btn btn-secondary">戻る</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // フォームセットのtbody要素を取得
    const formsetBody = document.getElementById('formset-body');

    // 現在のフォームの数を取得（管理フォームのTOTAL_FORMS）
    const formCountInput = document.getElementById('id_form-TOTAL_FORMS');
    let formCount = parseInt(formCountInput.value);

    // クリップボードから貼り付けた内容を処理するイベントリスナーを追加
    formsetBody.addEventListener('paste', function(event) {
        // クリップボードから貼り付けられたテキストを取得
        const clipboardData = event.clipboardData || window.clipboardData;
        const text = clipboardData.getData('Text');

        // 貼り付けられたテキストを行ごとに分割（改行コード '\n' で分割）
        const lines = text.split('\n');

        // 行ごとに処理
        lines.forEach((line) => {
            // 各行をタブ区切りで分割して、名前、メールアドレス、部門、部署を取得
            const columns = line.split('\t');
            
            if (columns.length >= 4) {  // 必要なカラム数（4列）が揃っている場合
                // フォームを追加
                addForm(columns[0], columns[1], columns[2], columns[3]);
            }
        });

        // 貼り付け後、フォーム数を更新
        formCountInput.value = formCount;
        
        // デフォルトの貼り付け動作を防ぐ
        event.preventDefault();
    });

    // 新しいフォームを追加する関数
    function addForm(name, email, division, team) {
        // 新しいフォーム行のtr要素を作成
        const newFormRow = document.createElement('tr');
        newFormRow.classList.add('form-row');
        
        // 新しいフォームのHTMLを設定（インデックスとともにフォームの名前を指定）
        newFormRow.innerHTML = `
            <td><input type="text" name="form-${formCount}-name" value="${name}" maxlength="100" id="id_form-${formCount}-name"></td>
            <td><input type="email" name="form-${formCount}-email" value="${email}" maxlength="100" id="id_form-${formCount}-email"></td>
            <td><input type="text" name="form-${formCount}-division" value="${division}" maxlength="100" id="id_form-${formCount}-division"></td>
            <td><input type="text" name="form-${formCount}-team" value="${team}" maxlength="100" id="id_form-${formCount}-team"></td>
            <td><button type="button" class="btn btn-danger remove-row">削除</button></td>
        `;
        
        // 新しく作成したフォームをformsetBody（tbody）に追加
        formsetBody.appendChild(newFormRow);

        // フォームの数をインクリメント
        formCount++;
    }

    // フォームの削除処理
    formsetBody.addEventListener('click', function(event) {
        // クリックされた要素が削除ボタンであった場合
        if (event.target.classList.contains('remove-row')) {
            // 対応するフォーム行（tr）を削除
            const row = event.target.closest('tr');
            row.remove();

            // 削除後、フォームの数をデクリメント
            formCount--;

            // 削除後、TOTAL_FORMSを更新
            formCountInput.value = formCount;
        }
    });
});

</script>

{% endblock %}